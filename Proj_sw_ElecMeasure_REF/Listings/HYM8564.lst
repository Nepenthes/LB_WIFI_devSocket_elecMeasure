C51 COMPILER V9.54   HYM8564                                                               09/07/2018 15:49:48 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE HYM8564
OBJECT MODULE PLACED IN .\Output\HYM8564.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE hwDriver\HYM8564.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE INCDIR(..\
                    -Proj_sw_ElecMeasure;.\Usr;.\Usr_lib;.\std_Lib;.\hwDriver;.\dataTrans) DEBUG PRINT(.\Listings\HYM8564.lst) OBJECT(.\Outpu
                    -t\HYM8564.obj)

line level    source

   1          #include "HYM8564.h"
   2          
   3          #include "dataTrans.h"
   4          
   5          #include "delay.h"
   6          #include "soft_uart.h"
   7          
   8          #include "stdio.h"
   9          #include "string.h"
  10          
  11          void Delay1us(void){            //@24.00MHz
  12   1      
  13   1              unsigned char i;
  14   1      
  15   1               _nop_();
  16   1               _nop_();
  17   1              i = 3;
  18   1              while (--i);
  19   1      }
  20          
  21          /****************IIC时序所需延时******************/
  22          void DelayXus(unsigned int x){
  23   1              
  24   1              u16 pdata loop = IIC_Delay_GainFac * x; //延时因数
  25   1              
  26   1              while(-- loop){
  27   2              
  28   2                      Delay1us();
  29   2              }
  30   1      }
  31          
  32          void iicHYM8564_pinInit(void){
  33   1      
  34   1              P1M1 &= 0x3F;
  35   1              P1M0 &= 0x3F;
  36   1      }
  37          
  38          void IIC_HYM8564_Start(void){ 
  39   1      
  40   1              IICA_ClrSCL;DelayXus(1);
  41   1              IICA_SetSDA;DelayXus(1);
  42   1              IICA_SetSCL;DelayXus(1);
  43   1              IICA_ClrSDA;DelayXus(1);
  44   1              IICA_ClrSCL;DelayXus(1);
  45   1      }
  46          
  47          void IIC_HYM8564_Stop(void){       
  48   1        
  49   1              IICA_ClrSDA;DelayXus(1);
  50   1              IICA_SetSCL;DelayXus(1);
  51   1              IICA_SetSDA;DelayXus(1);
  52   1              IICA_ClrSCL;DelayXus(5);
  53   1              IICA_SetSCL;
C51 COMPILER V9.54   HYM8564                                                               09/07/2018 15:49:48 PAGE 2   

  54   1      }
  55          
  56          unsigned char IIC_HYM8564_RecvAck(void){
  57   1      
  58   1              unsigned char ack = 0;
  59   1              unsigned int a = 0;
  60   1              
  61   1              IICA_ClrSCL;DelayXus(1);
  62   1              IICA_SetSCL;DelayXus(1);
  63   1              
  64   1              while((IICA_GetSDA) && (a < 2000))a++;
  65   1              
  66   1              ack = IICA_GetSDA; DelayXus(1);
  67   1              
  68   1              IICA_ClrSCL;
  69   1              
  70   1              return ack;
  71   1      }
  72          
  73          void IIC_HYM8564_SendByte(unsigned char dat){
  74   1      
  75   1              int i;
  76   1              
  77   1              IICA_ClrSCL;DelayXus(1);
  78   1              
  79   1              for (i = 7; i >= 0; i--){
  80   2              
  81   2                      IICA_ClrSCL;DelayXus(1);
  82   2                      IICA_ClrSDA;DelayXus(1);
  83   2                      
  84   2                      if (((dat >> i) & 0x01) != 0){
  85   3                      
  86   3                              IICA_SetSDA;
  87   3                              DelayXus(1);
  88   3                      }else{
  89   3                      
  90   3                              IICA_ClrSDA;
  91   3                              DelayXus(1);
  92   3                      }       
  93   2                      IICA_SetSCL;
  94   2                      DelayXus(1);
  95   2              }
  96   1              
  97   1              IICA_ClrSCL;
  98   1              DelayXus(1);
  99   1              return;
 100   1      }
 101          
 102          unsigned char IIC_HYM8564_ReadByte(void){  
 103   1      
 104   1          int i;
 105   1          unsigned char recv = 0;
 106   1              
 107   1          IICA_ClrSCL;DelayXus(1);
 108   1              
 109   1          for(i = 7; i >= 0; i --) {  
 110   2          
 111   2              recv <<= 1;
 112   2                      IICA_SetSCL;DelayXus(1);
 113   2                      
 114   2                      if(IICA_GetSDA)recv |= 0x01;    
 115   2                      else{
C51 COMPILER V9.54   HYM8564                                                               09/07/2018 15:49:48 PAGE 3   

 116   3                      
 117   3                              recv &= 0xfe;
 118   3                      }
 119   2                              
 120   2                      IICA_ClrSCL;
 121   2                      DelayXus(1);
 122   2          }
 123   1              
 124   1          return recv;
 125   1      }
 126          
 127          unsigned char read_HYM8564_byte(unsigned char add){
 128   1      
 129   1              unsigned char dat       = 0,
 130   1                                        temp  = 0;
 131   1      
 132   1              IIC_HYM8564_Start();
 133   1              IIC_HYM8564_SendByte(HYM8564_ADD_WR);
 134   1      
 135   1              temp = IIC_HYM8564_RecvAck();
 136   1      
 137   1              IIC_HYM8564_SendByte(add);
 138   1      
 139   1              temp = IIC_HYM8564_RecvAck();
 140   1      
 141   1              IIC_HYM8564_Start();
 142   1              IIC_HYM8564_SendByte(HYM8564_ADD_RD);
 143   1      
 144   1              temp = IIC_HYM8564_RecvAck();
 145   1              dat      = IIC_HYM8564_ReadByte();
 146   1      
 147   1              IIC_HYM8564_Stop();
 148   1      
 149   1              return(dat);
 150   1      }
 151          
 152          void write_HYM8564_byte(unsigned char add,unsigned char dat){
 153   1      
 154   1              unsigned char temp = 0;
 155   1              
 156   1              IIC_HYM8564_Start();
 157   1              IIC_HYM8564_SendByte(HYM8564_ADD_WR);
 158   1              
 159   1              temp = IIC_HYM8564_RecvAck();
 160   1              
 161   1              IIC_HYM8564_SendByte(add);
 162   1              
 163   1              temp = IIC_HYM8564_RecvAck();
 164   1              
 165   1              IIC_HYM8564_SendByte(dat);
 166   1              
 167   1              temp = IIC_HYM8564_RecvAck();
 168   1              
 169   1              IIC_HYM8564_Stop();
 170   1      }
 171          
 172          u8 DtoBCD(u8 num){
 173   1              
 174   1        return ((num / 10) << 4) + num % 10;
 175   1      }
 176          
 177          u8 BCDtoD(u8 num){
C51 COMPILER V9.54   HYM8564                                                               09/07/2018 15:49:48 PAGE 4   

 178   1              
 179   1        return ((num & 0x0f) + ((num >> 4) * 10));
 180   1      }
 181          
 182          void timeSet(stt_Time code timeDats){
 183   1      
 184   1              write_HYM8564_byte(registerADDR_HYM8564_YEAR,   DtoBCD(timeDats.time_Year));
 185   1              write_HYM8564_byte(registerADDR_HYM8564_MONTH,  DtoBCD(timeDats.time_Month));
 186   1              if(timeDats.time_Week)          /*必须加判断，否则周会被设成0*///数值为0则保持原样
 187   1              write_HYM8564_byte(registerADDR_HYM8564_WEEK,   DtoBCD(timeDats.time_Week));
 188   1              write_HYM8564_byte(registerADDR_HYM8564_DAY,    DtoBCD(timeDats.time_Day));
 189   1              write_HYM8564_byte(registerADDR_HYM8564_HOUR,   DtoBCD(timeDats.time_Hour));
 190   1              write_HYM8564_byte(registerADDR_HYM8564_MINUTE, DtoBCD(timeDats.time_Minute));
 191   1              if(timeDats.time_Second)        //数值为0则保持
 192   1              write_HYM8564_byte(registerADDR_HYM8564_SECOND, DtoBCD(timeDats.time_Second));
 193   1      }
 194          
 195          void timeRead(stt_Time *timeDats){
 196   1      
 197   1              timeDats->time_Year     = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_YEAR));
 198   1              timeDats->time_Month    = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_MONTH));
 199   1              timeDats->time_Week     = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_WEEK));
 200   1              timeDats->time_Day              = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_DAY));
 201   1              timeDats->time_Hour     = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_HOUR));
 202   1              timeDats->time_Minute   = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_MINUTE));
 203   1              timeDats->time_Second   = BCDtoD(read_HYM8564_byte(registerADDR_HYM8564_SECOND));
 204   1      }
 205          
 206          void time_Logout(stt_Time code timeDats){
 207   1      
 208   1              u8 xdata Log[80]        = {0};
 209   1              
 210   1              sprintf(Log, 
 211   1              "\n>>===时间戳===<<\n    20%d/%02d/%02d-W%01d\n        %02d:%02d:%02d\n", 
 212   1                              (int)timeDats.time_Year,
 213   1                              (int)timeDats.time_Month,
 214   1                              (int)timeDats.time_Day,
 215   1                              (int)timeDats.time_Week,
 216   1                              (int)timeDats.time_Hour,
 217   1                              (int)timeDats.time_Minute,
 218   1                              (int)timeDats.time_Second);
 219   1                              
 220   1      //      LogDats(Log, strlen(Log));
 221   1              uartObjWIFI_Send_String(Log, strlen(Log));
 222   1      }
 223          
 224          void HYM8564_Test(void){
 225   1              
 226   1              static u8 adjust_CNT = 0;
 227   1      
 228   1              stt_Time code timeSet_Tab1 = {18, 5, 4, 3, 9, 38, 23};
 229   1              
 230   1              stt_Time idata  valTime_Local   = {0};
 231   1              
 232   1              timeSet(timeSet_Tab1);
 233   1              
 234   1              while(1){
 235   2              
 236   2                      timeRead(&valTime_Local);
 237   2                      
 238   2                      time_Logout(valTime_Local);
 239   2                      
C51 COMPILER V9.54   HYM8564                                                               09/07/2018 15:49:48 PAGE 5   

 240   2                      delayMs(1000);
 241   2                      
 242   2                      if(adjust_CNT < 8)adjust_CNT ++;
 243   2                      else{
 244   3                      
 245   3                              adjust_CNT = 0;
 246   3                              
 247   3                              timeSet(timeSet_Tab1);
 248   3                      }
 249   2              }
 250   1      }
 251          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    833    ----
   CONSTANT SIZE    =    161    ----
   XDATA SIZE       =   ----      80
   PDATA SIZE       =   ----       2
   DATA SIZE        =      1      18
   IDATA SIZE       =   ----       7
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
